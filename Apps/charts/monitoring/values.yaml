# External Secrets for credentials
monitoringCredentials:
  enabled: true
  name: monitoring-credentials
  refreshInterval: "1h"
  target: labgrid-monitoring-credentials
  secretStoreRef:
    name: azure-kv-cluster-store
    kind: ClusterSecretStore
  data:
    - secretKey: grafana-admin-password
      remoteRef:
        key: labgrid-grafana-admin-password

###############################
# kube-prometheus-stack values #
###############################
kube-prometheus-stack:
  alertmanager:
    alertmanagerSpec:
      replicas: 1
      retention: 120h
      storage:
        volumeClaimTemplate:
          spec:
            storageClassName: synology-iscsi-delete
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
    ingress:
      enabled: true
      hosts:
        - alertmanager.labgrid.net
      path: /
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-production"
        nginx.ingress.kubernetes.io/backend-protocol: HTTP
        nginx.ingress.kubernetes.io/force-ssl-redirect: true

  prometheus:
    prometheusSpec:
      replicas: 1
      retention: 15d
      scrapeInterval: "30s"
      evaluationInterval: "30s"
      storageSpec:
        volumeClaimTemplate:
          spec:
            storageClassName: synology-iscsi-delete
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
            selector: {}
    ingress:
      enabled: true
      hosts:
        - prometheus.labgrid.net
      path: /
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-production"
        nginx.ingress.kubernetes.io/backend-protocol: HTTP
        nginx.ingress.kubernetes.io/force-ssl-redirect: true

  grafana:
    persistence:
      enabled: true
      type: sts
      storageClassName: synology-iscsi-delete
      accessModes: ["ReadWriteOnce"]
      size: 50Gi
    adminUser: admin
    admin:
      existingSecret: "labgrid-monitoring-credentials"
      # userKey: grafana-admin-user
      passwordKey: grafana-admin-password
    ingress:
      enabled: true
      hosts:
        - grafana.labgrid.net
      path: /
      ingressClassName: nginx
      annotations:
        cert-manager.io/cluster-issuer: "letsencrypt-production"
        nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
        nginx.ingress.kubernetes.io/force-ssl-redirect: "true"

    additionalDataSources:
      - name: Loki
        type: loki
        access: proxy
        url: http://loki-gateway.logging.svc.cluster.local
        # Even with auth_enabled: false, Loki requires an org ID header
        # This is a known quirk - the value can be anything since auth is disabled
        jsonData:
          httpHeaderName1: "X-Scope-OrgID"
        secureJsonData:
          httpHeaderValue1: "fake"

###############################
# Loki values #
###############################

# Loki retention - https://github.com/grafana/loki/issues/9207
loki:
  deploymentMode: SingleBinary

  # Number of replicas
  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      storageClass: synology-iscsi-delete
      accessModes:
        - ReadWriteOnce
      size: 50Gi

  # Component replicas (0 when using SingleBinary mode)
  write:
    replicas: 0
  read:
    replicas: 0
  backend:
    replicas: 0

  # Caching
  chunksCache:
    enabled: false
  resultsCache:
    enabled: false

  # Helm test
  test:
    enabled: false

  # All loki settings combined under one key
  loki:
    auth_enabled: false
    commonConfig:
      replication_factor: 1
    storage:
      type: filesystem
      filesystem:
        chunks_directory: /var/loki/chunks
        rules_directory: /var/loki/rules
